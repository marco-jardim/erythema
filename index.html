<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Erythema Detection - Skin Inflammation Analysis</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <nav>
            <h1>üî¨ Erythema Detection Tool</h1>
            <p>Advanced spectral filtering techniques for enhanced erythema detection in darker skin tones</p>
            <div class="nav-links">
                <button class="nav-link" data-modal="erythema">About Erythema</button>
                <button class="nav-link" data-modal="a-star">a* Channel</button>
                <button class="nav-link" data-modal="erythema-index">Erythema Index</button>
                <button class="nav-link" data-modal="ita">ITA¬∞ Index</button>
                <button class="nav-link" data-modal="rgb-ratio">RGB Ratio</button>
                <button class="nav-link" data-modal="melanin">Melanin Filter</button>
                <button class="nav-link" data-modal="contrast-boost">Contrast Enhancement</button>
                <button class="nav-link" data-modal="hair-reduction">Hair Reduction</button>
            </div>
        </nav>

        <div class="main-content">
            <div class="info-box">
                <p><strong>Note:</strong> Detecting erythema (skin redness/inflammation) in darker skin tones is challenging due to melanin masking. This tool applies various color-space transformations and spectral filters to enhance the visibility of inflammation markers.</p>
            </div>

            <div class="controls-section">
                <div class="control-group">
                    <label>Step 1: Upload or Take a Photo</label>
                    <div class="file-upload-group">
                        <label for="imageCapture" class="file-upload">
                            üì∑ Take Photo (Camera)
                        </label>
                        <label for="imageUpload" class="file-upload">
                            üìÅ Choose from Gallery
                        </label>
                    </div>
                    <input type="file" id="imageCapture" accept="image/*" capture="environment">
                    <input type="file" id="imageUpload" accept="image/*">
                    <span id="fileName" style="margin-left: 15px; color: #666;"></span>
                </div>

                <div class="control-group">
                    <label>Step 2: Early Filters (apply before others)</label>
                    <div class="technique-grid" id="earlyGrid">
                        <div class="technique-item" data-technique="hair-reduction">
                            <div class="order-badge">1</div>
                            <h4>‚úÇÔ∏è Hair Reduction</h4>
                            <p>Mask + inpaint to reduce hair interference</p>
                        </div>
                        <div class="technique-item" data-technique="melanin-filter">
                            <div class="order-badge">2</div>
                            <h4>üåì Melanin Compensation</h4>
                            <p>Reduces melanin masking</p>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label>Step 3: Main Filters (click to select, order matters)</label>
                    <div id="techniqueGrid">
                        <div class="technique-group">
                            <h5>Core / Early (apply first)</h5>
                            <div class="technique-grid">
                                <div class="technique-item" data-technique="a-star">
                                    <div class="order-badge">1</div>
                                    <h4>üß™ a* Channel (Lab)</h4>
                                    <p>Isolates red-green chromaticity</p>
                                </div>
                                <div class="technique-item" data-technique="erythema-index">
                                    <div class="order-badge">2</div>
                                    <h4>üìà Erythema Index (EI)</h4>
                                    <p>Quantifies redness intensity</p>
                                </div>
                                <div class="technique-item" data-technique="ita">
                                    <div class="order-badge">3</div>
                                    <h4>üìè ITA¬∞ (Typology Angle)</h4>
                                    <p>Adjusts for skin brightness</p>
                                </div>
                                <div class="technique-item" data-technique="rgb-ratio">
                                    <div class="order-badge">4</div>
                                    <h4>üåà Spectral Ratio Composite</h4>
                                    <p>G/R, R/G, (B¬∑G)/R pseudo-color (fake multispectral)</p>
                                </div>
                            </div>
                        </div>
                        <div class="technique-group">
                            <h5>Finishing / Late (apply last)</h5>
                            <div class="technique-grid">
                                <div class="technique-item" data-technique="contrast-boost">
                                    <div class="order-badge">5</div>
                                    <h4>üîÜ Contrast Enhancement</h4>
                                    <p>Increases visual clarity</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="control-group">
                    <label>Step 3: Apply Filters</label>
                    <div class="button-group">
                        <button class="btn btn-primary" onclick="applyFilters()">üé® Apply Selected Filters</button>
                        <button class="btn btn-secondary" onclick="resetFilters()">üîÑ Reset</button>
                        <button class="btn btn-secondary" onclick="clearSelection()">‚ùå Clear Selection</button>
                        <button class="btn derm-btn" type="button" id="dermBtn">ü©∫ Derm mode</button>
                        <input type="checkbox" id="dermToggle" style="display:none;">
                    </div>
                </div>
            </div>

            <div class="loading" id="loading">Processing image...</div>

            <div class="canvas-section" id="canvasSection" style="display: none;">
                <div class="canvas-container">
                    <h3>Before / After</h3>
                    <div class="view-toggle">
                        <button id="labViewBtn" class="toggle-btn active" type="button">üß™ Lab</button>
                        <button id="fusedViewBtn" class="toggle-btn" type="button">üî• Fused EI<sub>hb</sub></button>
                    </div>
                    <div class="overlap-wrapper" id="overlapWrapper">
                        <canvas id="processedCanvas"></canvas>
                        <canvas id="originalCanvas"></canvas>
                        <div id="compareSlider" class="slider-handle" aria-label="Reveal processed image"></div>
                    </div>
                    <div class="canvas-actions">
                        <label class="toggle-row">
                            <input type="checkbox" id="labToggle" disabled>
                            <span>Show erythema lab map (a*)</span>
                        </label>
                        <button class="download-btn" onclick="downloadProcessed()">üíæ Download Result</button>
                        <button class="download-btn" onclick="downloadLabMap()">‚¨áÔ∏è Lab Map</button>
                        <button class="download-btn" onclick="downloadConfidenceMask()">‚¨áÔ∏è Confidence Mask</button>
                    </div>
                </div>

                <div class="canvas-container">
                    <h3>Dual View: Lab Map & EI<sub>hb</sub> Heatmap</h3>
                    <div class="dual-grid">
                        <div>
                            <h4 style="margin-bottom:8px;">Lab Map (L<sub>max</sub>‚ÄìL)√óa*</h4>
                            <div class="canvas-wrapper">
                                <canvas id="labPreviewCanvas"></canvas>
                            </div>
                        </div>
                        <div>
                            <h4 style="margin-bottom:8px;">Fused EI<sub>hb</sub> Heatmap</h4>
                            <div class="canvas-wrapper">
                                <canvas id="heatmapPreviewCanvas"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals for technique explanations -->
    <div id="modalErythema" class="modal">
        <div class="modal-content">
            <span class="close" data-close="erythema">&times;</span>
            <h2>About Erythema Detection</h2>
            <p>Erythema is the reddening of the skin caused by increased blood flow in superficial capillaries. It's a key indicator of inflammation, allergic reactions, or irritation.</p>
            
            <h3>Challenges in Darker Skin</h3>
            <p>Detecting erythema in darker skin tones is particularly challenging because:</p>
            <ul>
                <li>Melanin absorbs light across a broad spectrum, masking the red coloration</li>
                <li>Visual assessment alone can miss subtle inflammatory changes</li>
                <li>Standard RGB imaging may not capture the full spectral signature</li>
                <li>Individual typology angle (ITA) varies significantly across populations</li>
            </ul>

            <h3>Solution Approach</h3>
            <p>This tool employs multiple computational techniques that transform and analyze images in different color spaces to enhance the visibility of erythema markers, making inflammation detection more reliable across all skin tones.</p>
        </div>
    </div>

    <div id="modalAStar" class="modal">
        <div class="modal-content">
            <span class="close" data-close="a-star">&times;</span>
            <h2>a* Channel (Lab Color Space)</h2>
            
            <h3>What is it?</h3>
            <p>The a* channel is part of the CIE Lab color space, which separates color information into:</p>
            <ul>
                <li><strong>L*</strong>: Lightness (0-100)</li>
                <li><strong>a*</strong>: Green-Red axis (negative to positive)</li>
                <li><strong>b*</strong>: Blue-Yellow axis (negative to positive)</li>
            </ul>

            <h3>Why it's useful for erythema</h3>
            <p>This tool follows the literature outline: it builds an erythema map using <strong>E = (L<sub>max</sub> ‚Äì L) √ó a*</strong>, where L<sub>max</sub> is the brightest L* in the image (or 100 if unavailable). The map is then normalized 0‚Äì255 for visualization. This amplifies redness (a* &gt; 0) more in darker areas (lower L*), compensating for melanin masking.</p>

            <h3>Application</h3>
            <p>The pipeline converts RGB to Lab, finds L<sub>max</sub>, computes the per-pixel map <em>(L<sub>max</sub> ‚àí L) √ó a*</em>, and normalizes it to grayscale. Higher values highlight erythema while accounting for skin brightness.</p>
        </div>
    </div>

    <div id="modalErythemaIndex" class="modal">
        <div class="modal-content">
            <span class="close" data-close="erythema-index">&times;</span>
            <h2>Erythema Index (EI)</h2>
            
            <h3>What is it?</h3>
            <p>The Erythema Index is a quantitative measure of skin redness calculated from color space coordinates. It provides a numerical value that correlates with the severity of erythema.</p>

            <h3>Calculation Method</h3>
            <p>The EI is commonly calculated from visible-light reflectance using:</p>
            <p><strong>EI = log<sub>10</sub>(R / G)</strong></p>
            <p>where R and G are the red and green channel reflectance (or linearized pixel intensity) values. Higher EI values indicate stronger erythema.</p>

            <h3>Clinical Relevance</h3>
            <ul>
                <li>Provides objective, reproducible measurements</li>
                <li>Useful for tracking changes over time</li>
                <li>Can detect subtle changes not visible to the naked eye</li>
                <li>Helps standardize assessment across different skin types</li>
            </ul>
        </div>
    </div>

    <div id="modalITA" class="modal">
        <div class="modal-content">
            <span class="close" data-close="ita">&times;</span>
            <h2>Individual Typology Angle (ITA¬∞)</h2>
            
            <h3>What is it?</h3>
            <p>ITA¬∞ is a measure used to classify skin color and adjust for baseline pigmentation. It's calculated from Lab color space values and helps normalize measurements across different skin tones.</p>

            <h3>Formula</h3>
            <p><strong>ITA¬∞ = [arctan((L* - 50) / b*)] √ó (180/œÄ)</strong></p>

            <h3>Skin Type Categories</h3>
            <ul>
                <li>ITA¬∞ > 55¬∞: Very light</li>
                <li>41¬∞ to 55¬∞: Light</li>
                <li>28¬∞ to 41¬∞: Intermediate</li>
                <li>10¬∞ to 28¬∞: Tan</li>
                <li>-30¬∞ to 10¬∞: Brown</li>
                <li>< -30¬∞: Dark</li>
            </ul>

            <h3>Application in Erythema Detection</h3>
            <p>By incorporating ITA¬∞ into the analysis, we can adjust erythema detection sensitivity based on baseline skin pigmentation, improving accuracy across all Fitzpatrick skin types.</p>
        </div>
    </div>

    <div id="modalRGBRatio" class="modal">
        <div class="modal-content">
            <span class="close" data-close="rgb-ratio">&times;</span>
            <h2>Spectral Ratio Composite</h2>
            
            <h3>What is it?</h3>
            <p>This technique builds three ratio maps inspired by multispectral separation using only RGB:</p>
            <ul>
                <li>G/R (vermelho forte ‚áí valor baixo)</li>
                <li>R/G (vermelho forte ‚áí valor alto)</li>
                <li>(B¬∑G)/R (fundo neutro alto, regi√µes vermelhas baixas)</li>
            </ul>

            <h3>Method</h3>
            <p>Cada mapa √© normalizado para 0‚Äì255; G/R e (B¬∑G)/R s√£o invertidos para que regi√µes vermelhas apare√ßam claras. Em seguida montamos um pseudo-color: R = inv(G/R), G = R/G, B = inv((B¬∑G)/R).</p>

            <h3>Advantages</h3>
            <ul>
                <li>Usa somente RGB mas separa componentes com diferentes sensibilidades ao vermelho</li>
                <li>Computacionalmente leve</li>
                <li>Destaca inflama√ß√£o tornando regi√µes vermelhas mais brilhantes</li>
                <li>Pode ser exibido como tr√™s mapas em tons de cinza ou combinado em pseudo-cor</li>
            </ul>
        </div>
    </div>

    <div id="modalMelanin" class="modal">
        <div class="modal-content">
            <span class="close" data-close="melanin">&times;</span>
            <h2>Melanin Compensation Filter</h2>
            
            <h3>The Challenge</h3>
            <p>Melanin is the pigment responsible for skin color and absorbs light broadly across the visible spectrum. This absorption masks the hemoglobin signature that indicates erythema, making detection difficult in darker skin.</p>

            <h3>Compensation Strategy</h3>
            <p>This filter attempts to mathematically compensate for melanin absorption by:</p>
            <ul>
                <li>Estimating baseline melanin content from L* and b* values</li>
                <li>Applying inverse absorption models</li>
                <li>Enhancing the hemoglobin-specific spectral features</li>
                <li>Adjusting contrast in the red wavelength range</li>
            </ul>

            <h3>Research Basis</h3>
            <p>This approach is based on research into multispectral imaging and independent component analysis (ICA) that separates melanin and hemoglobin contributions to skin color.</p>

            <h3>Note</h3>
            <p>While this technique can enhance visualization, it should be used in conjunction with clinical assessment. It's particularly useful when combined with other techniques in a multi-step pipeline.</p>
        </div>
    </div>

    <div id="modalContrastBoost" class="modal">
        <div class="modal-content">
            <span class="close" data-close="contrast-boost">&times;</span>
            <h2>Contrast Enhancement</h2>
            
            <h3>What is it?</h3>
            <p>Contrast enhancement is a fundamental image processing technique that increases the difference between light and dark regions, making features more visually distinct.</p>

            <h3>How it works</h3>
            <p>This technique applies a linear contrast stretch to each color channel:</p>
            <ul>
                <li>Pixels darker than middle gray become darker</li>
                <li>Pixels lighter than middle gray become lighter</li>
                <li>The overall dynamic range is expanded</li>
                <li>Subtle variations become more apparent</li>
            </ul>

            <h3>Application to Erythema Detection</h3>
            <p>When used in combination with other filters, contrast enhancement can:</p>
            <ul>
                <li>Amplify subtle color differences introduced by previous filters</li>
                <li>Make erythema markers more visually prominent</li>
                <li>Improve the interpretability of processed images</li>
                <li>Help distinguish between different levels of inflammation</li>
            </ul>

            <h3>Best Practices</h3>
            <p>Contrast enhancement is most effective when applied as the final step in a processing pipeline, after color-space transformations and spectral filtering have isolated the erythema signature.</p>
        </div>
    </div>

    <div id="modalHairReduction" class="modal">
        <div class="modal-content">
            <span class="close" data-close="hair-reduction">&times;</span>
            <h2>Hair Reduction</h2>

            <h3>Goal</h3>
            <p>Minimize hair interference so erythema metrics (a*, EI, ratios) rely on skin pixels instead of dark hair strands.</p>

            <h3>Pipeline used here</h3>
            <ul>
                <li><strong>Detect hair</strong>: black-hat style line enhancement on grayscale + 10% darkest L* percentile mask.</li>
                <li><strong>Clean mask</strong>: 3√ó3 morphological closing to remove noise and fill gaps.</li>
                <li><strong>Inpaint</strong>: replace masked pixels with nearby skin averages (radius 2) to estimate skin under hair.</li>
                <li><strong>Protect metrics</strong>: hair pixels are excluded from L<sub>max</sub> / min-max stats and rendered black in the Lab map.</li>
            </ul>

            <h3>When to use</h3>
            <p>Enable this early filter when dense hair would skew redness calculations or hide inflammation. It runs before all other filters.</p>
        </div>
    </div>

    <footer style="text-align:center; padding:20px; color:#f0f0f0; font-size:14px;">
        ¬© 2025 Marco Jardim ¬∑ <a href="https://www.gnu.org/licenses/gpl-3.0.en.html" style="color:#ffe680;">GPL v3</a> ¬∑ <a href="https://github.com/marco-jardim/erythema" style="color:#ffe680;">Repository</a>
    </footer>
    <script type="module" src="./js/app.js"></script>
</body>
</html>
